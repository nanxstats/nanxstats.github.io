<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title> Disposable Computing with callr - Nan Xiao | 肖楠 </title>
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="referrer" content="no-referrer">
    <meta name="description" content="Use callr to work around manual connection management." />
    <meta property="og:site_name" content="Nan Xiao | 肖楠" />
    <meta property="og:locale" content="en_US" />
    <meta property="og:type" content="article" />
    <meta property="og:url" content="https://nanx.me/blog/post/disposable-computing-with-callr/" />
    <meta property="og:title" content="Disposable Computing with callr" />
    <meta property="og:image" content="https://nanx.me/image/disposable-gloves-thumb-up-uniqueton.jpg" />
    <meta property="og:description" content="Use callr to work around manual connection management." />

    <meta name="twitter:card" content="summary_large_image" />
    
    <meta name="twitter:site" content="@nanxstats">
    <meta name="twitter:creator" content="@nanxstats">
    
    <meta name="twitter:title" content="Disposable Computing with callr" />
    <meta name="twitter:description" content="Use callr to work around manual connection management." />
    <meta name="twitter:image" content="https://nanx.me/image/disposable-gloves-thumb-up-uniqueton.jpg" />

    <link rel="canonical" href="https://nanx.me/blog/post/disposable-computing-with-callr/">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha256-aAr2Zpq8MZ+YA/D6JtRD3xtrwpEz2IqOS+pWD/7XKIw=" crossorigin="anonymous" />

    <link rel="stylesheet" href="https://nanx.me/css/custom.css" />

    
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.14.2/styles/tomorrow.min.css" integrity="sha256-0QU8ry64q+N6YBIEF/6XF6vUeF15gbNO4tLS6ikk0FI=" crossorigin="anonymous" />
    

    

    <link rel="shortcut icon"
        href="https://nanx.me/image/favicon.png">

    
        <link href="https://nanx.me/index.xml" rel="alternate" type="application/rss+xml" title="Nan Xiao | 肖楠" />
    
</head>

<body>
    
    <div class="my-4 my-md-5 header">
    <div class="container">
        <div class="row">
            <div class="col-auto offset-md-1 d-none d-md-block">
                
                    <a href="https://nanx.me/">
                        <img class="ml-md-4 logo img-fluid d-block rounded-circle" src="https://nanx.me/image/nanxiao.jpg" alt="logo">
                    </a>
                
            </div>
            <div class="col-auto align-self-center mr-auto">
                <a href="https://nanx.me/">
                    <h1 class="name">Nan Xiao</h1>
                </a>

                <ul class="nav nav-primary">
                    
                        <li class="nav-item">
                            <a class="text-uppercase nav-link text-software" href="https://nanx.me/software/">
                                
                                Software
                            </a>
                        </li>
                    
                        <li class="nav-item">
                            <a class="text-uppercase nav-link text-papers" href="https://nanx.me/papers/">
                                
                                Papers
                            </a>
                        </li>
                    
                        <li class="nav-item">
                            <a class="text-uppercase nav-link text-talks" href="https://nanx.me/talks/">
                                
                                Talks
                            </a>
                        </li>
                    
                        <li class="nav-item">
                            <a class="text-uppercase nav-link text-blog" href="https://nanx.me/blog/">
                                
                                Blog
                            </a>
                        </li>
                    

                    
                </ul>

            </div>
        </div>
    </div>
</div>


    <div class="content">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-sm-12 col-md-10">
                    <h1 class="mx-0 mx-md-4 blog-post-title">Disposable Computing with callr</h1>

                    <div class="mb-md-4 meta">
                        
                            
                                <span class="author" title="Nan Xiao">
                                    Nan Xiao
                                </span>
                            
                        

                        <span class="date middot" title='Sat Apr 11 2020 17:30:00 UTC'>
                            2020-04-11
                        </span>

                        <span class="reading-time middot">
                            3 minute read
                        </span>

                        <div class="d-none d-md-inline tags">
                            <ul class="list-unstyled d-inline">
                                
                                    <li class="d-inline middot">
                                        <a href="https://nanx.me/tags/r">R</a>
                                    </li>
                                
                                    <li class="d-inline middot">
                                        <a href="https://nanx.me/tags/callr">callr</a>
                                    </li>
                                
                                    <li class="d-inline middot">
                                        <a href="https://nanx.me/tags/rcpi">Rcpi</a>
                                    </li>
                                
                            </ul>
                        </div>

                        <div class="d-none d-md-inline tags">
                            <ul class="list-unstyled d-inline">
                                
                                
                            </ul>
                        </div>
                    </div>

                    <div class="markdown">
                        
    
<script src="https://nanx.me/rmarkdown-libs/header-attrs/header-attrs.js"></script>


<div class="figure">
<img src="https://nanx.me/image/disposable-gloves-thumb-up-uniqueton.jpg" alt="" />
<p class="caption">Photo by <a href="https://unsplash.com/photos/oemojNQYYe4"><span class="citation">@uniqueton</span></a>.</p>
</div>
<p>Runtime errors can be tricky and costly to resolve for any programming language, and these errors frequently happen when <a href="https://stat.ethz.ch/R-manual/R-devel/library/base/html/connections.html">managing (file) connections</a>. Boris posted such an <a href="https://github.com/nanxstats/Rcpi/issues/9">issue</a> when using my R package <a href="https://bioconductor.org/packages/Rcpi/">Rcpi</a>. I rephrase it here as:</p>
<pre class="r"><code>library(&quot;Rcpi&quot;)

dir.create(&quot;test&quot;)
for (i in 1:2000) {
  file.copy(
    system.file(&quot;compseq/DB00530.sdf&quot;, package = &quot;Rcpi&quot;),
    paste0(&quot;test/&quot;, i, &quot;.sdf&quot;)
  )
}

fns &lt;- list.files(&quot;test/&quot;, pattern = &quot;.sdf$&quot;, full.names = TRUE)

for (i in 1:length(fns)) {
  cat(&quot;\014&quot;, i, &quot;\n&quot;)
  Rcpi::convMolFormat(infile = fns[i], outfile = &quot;temp.smi&quot;, from = &quot;sdf&quot;, to = &quot;smiles&quot;)
  Rcpi::readMolFromSmi(smifile = &quot;temp.smi&quot;, type = &quot;text&quot;)[1]
}</code></pre>
<p>The purpose of the code is simple: convert a collection of files existing in the SDF format to SMILES format (both are common chemical file formats), then read the SMILES format files as character strings sequentially. Nothing surprising.</p>
<p>However, after looping over about 500 input files, R yields an error saying:</p>
<pre class="text"><code>Error in file(file, &quot;r&quot;) : cannot open the connection
In addition: Warning message:
In file(file, &quot;r&quot;) : cannot open file &#39;temp.smi&#39;: Too many open files</code></pre>
<p>This is because there are certain limits on the number of connections one can open in R. See Matthew Shotwell’s <a href="https://biostatmatt.com/R/R-conn-ints.pdf">R Connection Internals</a> for technical details. If we look closely, the connection-related code is:</p>
<pre class="r"><code>for (i in input_files) {
  read_compute_write(input = i, output = &quot;output_file&quot;)
  read_file(&quot;output_file&quot;)
  ...
}</code></pre>
<p>where the <code>read_compute_write()</code> function is a wrapper of a function from another package that uses C++ to open low-level connections to read and write files, and <code>read_file()</code> uses R’s native <code>scan()</code> to read files. More often than not, there could be additional operations that manipulate connections in the for loop.</p>
<p>In such situations, I usually do not want to spend a few hours fighting with the “proper” solution — manual connection life cycle management. This is not so dissimilar with garbage collection (GC) in memory management — although you want to enjoy the manual control once a while, sometimes you wish it to be automatic.</p>
<p>What could be an alternative solution? Since the core issue here is that one R process cannot open many connections at once, what if we open a below-the-limit number of connections in separate child R processes, do the computation, and collect the results back to the parent process? Yes, this is easily doable via the <a href="https://cran.r-project.org/package=callr">callr</a> package if you haven’t heard of it:</p>
<pre class="r"><code>library(&quot;Rcpi&quot;)
library(&quot;callr&quot;)

dir.create(&quot;test&quot;)
for (i in 1:2000) {
  file.copy(
    system.file(&quot;compseq/DB00530.sdf&quot;, package = &quot;Rcpi&quot;),
    paste0(&quot;test/&quot;, i, &quot;.sdf&quot;)
  )
}

fns &lt;- list.files(&quot;test/&quot;, pattern = &quot;.sdf$&quot;, full.names = TRUE)

convert &lt;- function(fns, idx) {
  callr::r(function(fns, idx) {
    smiles &lt;- c()
    for (i in idx) {
      Rcpi::convMolFormat(infile = fns[i], outfile = &quot;temp.smi&quot;, from = &quot;sdf&quot;, to = &quot;smiles&quot;)
      smiles &lt;- c(smiles, Rcpi::readMolFromSmi(smifile = &quot;temp.smi&quot;, type = &quot;text&quot;)[1])
    }
    smiles
  }, args = list(fns, idx))
}


k &lt;- length(fns)
chunks &lt;- split(1:k, ceiling(seq_along(1:k) / 400))
smi &lt;- rep(NA, k)
for (i in 1:length(chunks)) smi[chunks[[i]]] &lt;- convert(fns, chunks[[i]])
smi</code></pre>
<p>The code can still be further vectorized, but you got the idea. Note that extending such a workaround to other use cases may create an antipattern. Although I do not think writing “disposable code” for “disposable computing” is a problem if it gets the work done, I do not recommend such approaches either unless you are in a hurry.</p>



                    </div>

                    
                        <div class="navigation">
                            <div class="row">
                                <div class="col-12 col-md-6">
                                    
                                        <div class="mx-0 mx-md-4 mt-4 text-left">
                                            <a href="https://nanx.me/blog/post/self-host-shiny-apps/">« Self-Hosting Shiny Apps with Linode and Cloudflare</a>
                                        </div>
                                    
                                </div>
                                <div class="col-12 col-md-6">
                                    
                                        <div class="mx-0 mx-md-4 mt-4 text-right">
                                            <a href="https://nanx.me/blog/post/distill-syntax-highlight/">Customize Syntax Highlighting for R distill Websites »</a>
                                        </div>
                                    
                                </div>
                            </div>
                        </div>
                    
                </div>
            </div>
        </div>
    </div>

    <section id="comments">

      <div class="py-3 content">
            <div class="container">
                  <div class="row justify-content-center">
                        <div class="col-sm-12 col-md-10">
                              <div class="comments">
                                    <div id="disqus_thread"></div>
                              </div>
                        </div>
                  </div>
            </div>
      </div>

      <script type="text/javascript">
            (function () {
                  
                  
                  if (window.location.hostname == "localhost")
                        return;

                  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                  var disqus_shortname = 'nan-xiao-blog';
                  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
      </script>
      <noscript>
            Please enable JavaScript to view the
            <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
      </noscript>
</section>
    <div class="my-4 footer">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-sm-12 col-md-5">
                
                    <div class="mx-0 mx-md-4 text-left">
                        
                            <a href="https://nanx.me/">© 2020 Nan Xiao</a>
                        
                    </div>
                
            </div>
            <div class="col-sm-12 col-md-5">
                <div class="mx-0 mx-md-4 text-right">
                    
                        <a href="https://github.com/nanxstats" target="_blank">
                            <img class="icon" src="https://nanx.me/img/github.svg" alt="GitHub" />
                        </a>
                    

                    

                    

                    
                    <a href="https://twitter.com/nanxstats" target="_blank">
                        <img class="icon" src="https://nanx.me/img/twitter.svg" alt="Twitter" />
                    </a>
                    

                    
                    <a href="https://www.linkedin.com/in/nanxstats" target="_blank">
                        <img class="icon" src="https://nanx.me/img/linkedin.svg" alt="LinkedIn" />
                    </a>
                    

                    

                    

                    

                    
                    <a href="mailto:me@nanx.me">
                        <img class="icon" src="https://nanx.me/img/email.svg" alt="Email" />
                    </a>
                    

                    
                        <a href="https://nanx.me/index.xml" class="mr-0">
                            <img class="icon" src="https://nanx.me/img/rss.svg" alt="RSS" />
                        </a>
                    

                    
                </div>
            </div>
        </div>
    </div>
</div>



    

    
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.14.2/highlight.min.js" integrity="sha256-sNPiigbfSkqUzMc5rgrdztLnneCMAp6W9wetJUZu9Zw=" crossorigin="anonymous"></script>
        
        <script>
            window.addEventListener('load', function() {
                hljs.initHighlighting();
            }, true);
        </script>
    

    

    
    
        
<script src="https://nanx.me/js/math-code.js"></script>
<script async src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script>


    
</body>

</html>
