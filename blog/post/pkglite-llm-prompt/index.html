<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title> Prompt LLMs with R Package Source Code Using pkglite - Nan Xiao | 肖楠 </title>
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="referrer" content="no-referrer">
    <meta name="description" content="Learn how to prompt large language models with complete R package source code using pkglite. pkglite automates the process of converting R packages to plain text files, making it easier to provide accurate context for coding questions and minimize hallucination problems in LLM responses. This post demonstrates how pkglite, originally designed for regulatory submissions, can be leveraged for effective prompt engineering.
" />

    
    <meta property="og:type" content="article" />
    <meta property="og:locale" content="en_US" />
    <meta property="og:site_name" content="Nan Xiao | 肖楠" />
    <meta property="og:url" content="https://nanx.me/blog/post/pkglite-llm-prompt/" />
    <meta property="og:title" content="Prompt LLMs with R Package Source Code Using pkglite" />
    <meta property="og:description" content="Learn how to prompt large language models with complete R package source code using pkglite. pkglite automates the process of converting R packages to plain text files, making it easier to provide accurate context for coding questions and minimize hallucination problems in LLM responses. This post demonstrates how pkglite, originally designed for regulatory submissions, can be leveraged for effective prompt engineering.
" />
    <meta property="og:image" content="https://nanx.me/image/google-deepmind-zyXg8_OOww8-unsplash.jpg" />
    <meta property="og:image:secure_url" content="https://nanx.me/image/google-deepmind-zyXg8_OOww8-unsplash.jpg" />
    <meta property="article:published_time" content="2024-03-28T20:00:00Z" />
    <meta property="article:modified_time" content="2024-03-28T20:00:00Z" />
    <meta property="article:author" content="Nan Xiao" />

    
    <meta name="twitter:card" content="summary_large_image" />
    
    <meta name="twitter:site" content="@nanxstats">
    <meta name="twitter:creator" content="@nanxstats">
    
    <meta name="twitter:title" content="Prompt LLMs with R Package Source Code Using pkglite" />
    <meta name="twitter:description" content="Learn how to prompt large language models with complete R package source code using pkglite. pkglite automates the process of converting R packages to plain text files, making it easier to provide accurate context for coding questions and minimize hallucination problems in LLM responses. This post demonstrates how pkglite, originally designed for regulatory submissions, can be leveraged for effective prompt engineering.
" />
    <meta name="twitter:image" content="https://nanx.me/image/google-deepmind-zyXg8_OOww8-unsplash.jpg" />
    <meta name="twitter:image:alt" content="Prompt LLMs with R Package Source Code Using pkglite" />

    
    <meta property="og:linkedin:actor" content="nanxstats" />

    <link rel="canonical" href="https://nanx.me/blog/post/pkglite-llm-prompt/">

    
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        serif: ['"Martina Plantijn"', 'Newsreader', 'Georgia', 'Cambria', '"Times New Roman"', 'Times', 'serif'],
                        sans: ['"Instrument Sans"', 'system-ui', '-apple-system', '"Segoe UI"', 'Roboto', '"Helvetica Neue"', 'Arial', 'sans-serif'],
                        mono: ['"Liga Noto Sans Mono"', 'ui-monospace', 'SFMono-Regular', '"SF Mono"', 'Menlo', 'Consolas', 'monospace'],
                    },
                    colors: {
                        paper: '#fdfdfd',
                        ink: '#1c1c1c',
                        accent: '#991b1b',  
                    },
                    typography: {
                        DEFAULT: {
                            css: {
                                maxWidth: 'none',
                                color: '#1c1c1c',
                                '--tw-prose-body': '#1c1c1c',
                                '--tw-prose-headings': '#1c1c1c',
                                '--tw-prose-links': '#991b1b',
                                '--tw-prose-bold': '#111827',
                                '--tw-prose-counters': '#71717a',
                                '--tw-prose-bullets': '#d4d4d8',
                                '--tw-prose-hr': '#e4e4e7',
                                '--tw-prose-quotes': '#1c1c1c',
                                '--tw-prose-quote-borders': '#d4d4d8',
                                '--tw-prose-captions': '#71717a',
                                '--tw-prose-code': '#1c1c1c',
                                '--tw-prose-pre-code': '#1c1c1c',
                                '--tw-prose-pre-bg': '#fdfdfd',
                                '--tw-prose-th-borders': '#d4d4d8',
                                '--tw-prose-td-borders': '#e4e4e7',
                                'pre': {
                                    color: '#1c1c1c',
                                    backgroundColor: '#fdfdfd !important',
                                    border: '1px solid #e4e4e7',
                                },
                                a: {
                                    color: '#991b1b',
                                    textDecoration: 'none',
                                    fontWeight: '400',
                                    borderBottom: '1px solid transparent',
                                    transition: 'border-color 0.2s ease, color 0.2s ease',
                                },
                                'a:hover': {
                                    color: '#991b1b !important',
                                    borderBottomColor: '#991b1b !important',
                                },
                                h1: { fontFamily: '"Instrument Sans", sans-serif', fontWeight: '500', letterSpacing: '-0.025em' },
                                h2: { fontFamily: '"Instrument Sans", sans-serif', fontWeight: '500', letterSpacing: '-0.025em', marginTop: '2em' },
                                h3: { fontFamily: '"Instrument Sans", sans-serif', fontWeight: '500' },
                                h4: { fontFamily: '"Instrument Sans", sans-serif', fontWeight: '500' },
                                blockquote: {
                                    fontStyle: 'italic',
                                    fontWeight: '400',
                                    borderLeftWidth: '2px',
                                },
                                'code::before': { content: 'none' },
                                'code::after': { content: 'none' },
                                ':not(pre) > code': {
                                    fontWeight: '400',
                                    color: '#1c1c1c !important',
                                    backgroundColor: '#f4f4f5 !important',
                                    padding: '0.2em 0.4em',
                                    borderRadius: '0.25rem',
                                    fontSize: '0.875em',
                                },
                            },
                        },
                    },
                },
            },
        }
    </script>

    <style type="text/tailwindcss">
        @layer utilities {
            .tufte-grid {
                display: grid;
                grid-template-columns: 1fr min(65ch, 100%) 1fr;
                column-gap: 2rem;
            }
            .tufte-grid > * {
                grid-column: 2;
            }
            .tufte-grid > .full-width {
                grid-column: 1 / -1;
            }
            .tufte-grid > .margin-note {
                grid-column: 3;
                font-family: "Instrument Sans", sans-serif;
                font-size: 0.875rem;
                line-height: 1.4;
                color: #52525b;  
                margin-top: 0.25rem;
            }
            @media (max-width: 1024px) {
                .tufte-grid {
                    grid-template-columns: 1rem 1fr 1rem;
                }
                .tufte-grid > .margin-note {
                    grid-column: 2;
                    margin-top: 0.5rem;
                    margin-bottom: 1rem;
                    padding-left: 1rem;
                    border-left: 2px solid #e4e4e7;
                }
            }
        }
    </style>

    <link rel="stylesheet" href="https://nanx.me/css/custom.css" />

    
    <link rel="stylesheet" href="https://nanx.me/css/textmate.css" />
    

    

    <link rel="shortcut icon"
        href="https://nanx.me/image/favicon.png">

    
</head>

<body class="bg-paper text-ink font-serif antialiased selection:bg-zinc-200">
    
<header class="py-8 lg:py-12 text-sm font-sans tracking-wide max-w-[67ch] mx-auto w-full px-4 sm:px-6">
    <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 sm:gap-0">
        <a href="https://nanx.me/" class="font-medium text-ink hover:text-accent transition-colors">
            Nan Xiao
        </a>
        <nav class="flex flex-wrap gap-4 sm:gap-6 text-zinc-600">
            
            
            <a class="text-ink font-medium"
                href="https://nanx.me/blog/">
                Blog
            </a>
            
            <a class="hover:text-accent transition-colors"
                href="https://nanx.me/software/">
                Software
            </a>
            
            <a class="hover:text-accent transition-colors"
                href="https://nanx.me/papers/">
                Papers
            </a>
            
            <a class="hover:text-accent transition-colors"
                href="https://nanx.me/talks/">
                Talks
            </a>
            
            <a class="hover:text-accent transition-colors"
                href="https://nanx.me/books/">
                Books
            </a>
            
            <a class="hover:text-accent transition-colors"
                href="https://nanx.me/about/">
                About
            </a>
            
        </nav>
    </div>
</header>

<main class="content my-10 lg:my-20 max-w-[65ch] mx-auto w-full px-4 sm:px-6">
    <article>
        <header class="mb-14">
            <h1 class="text-3xl lg:text-4xl font-sans tracking-tight text-ink font-medium mb-4">Prompt LLMs with R Package Source Code Using pkglite</h1>

            <div class="text-zinc-500 font-sans text-sm tracking-wide">
                
                
                <span class="author" title="Nan Xiao">
                    Nan Xiao
                </span>
                
                

                <span class="date middot" title='Thu Mar 28 2024 20:00:00 UTC'>
                    March 28, 2024
                </span>

                <span class="reading-time middot">
                    5 min read
                </span>

                <div class="mt-8 flex flex-wrap gap-2">
                    
                    <a href="https://nanx.me/tags/large-language-model"
                        class="inline-flex items-center px-3 py-1 rounded-full bg-zinc-100 text-zinc-600 hover:bg-zinc-200 hover:text-ink transition-colors text-xs font-medium tracking-wide">
                        large language model
                    </a>
                    
                    <a href="https://nanx.me/tags/retrieval-augmented-generation"
                        class="inline-flex items-center px-3 py-1 rounded-full bg-zinc-100 text-zinc-600 hover:bg-zinc-200 hover:text-ink transition-colors text-xs font-medium tracking-wide">
                        retrieval-augmented generation
                    </a>
                    
                    <a href="https://nanx.me/tags/prompt-engineering"
                        class="inline-flex items-center px-3 py-1 rounded-full bg-zinc-100 text-zinc-600 hover:bg-zinc-200 hover:text-ink transition-colors text-xs font-medium tracking-wide">
                        prompt engineering
                    </a>
                    
                    <a href="https://nanx.me/tags/r"
                        class="inline-flex items-center px-3 py-1 rounded-full bg-zinc-100 text-zinc-600 hover:bg-zinc-200 hover:text-ink transition-colors text-xs font-medium tracking-wide">
                        R
                    </a>
                    
                    <a href="https://nanx.me/tags/r-packages"
                        class="inline-flex items-center px-3 py-1 rounded-full bg-zinc-100 text-zinc-600 hover:bg-zinc-200 hover:text-ink transition-colors text-xs font-medium tracking-wide">
                        R packages
                    </a>
                    
                    <a href="https://nanx.me/tags/pkglite"
                        class="inline-flex items-center px-3 py-1 rounded-full bg-zinc-100 text-zinc-600 hover:bg-zinc-200 hover:text-ink transition-colors text-xs font-medium tracking-wide">
                        pkglite
                    </a>
                    
                    <a href="https://nanx.me/tags/gptstudio"
                        class="inline-flex items-center px-3 py-1 rounded-full bg-zinc-100 text-zinc-600 hover:bg-zinc-200 hover:text-ink transition-colors text-xs font-medium tracking-wide">
                        gptstudio
                    </a>
                    
                    
                    
                </div>
            </div>

        </header>

        <div class="prose prose-zinc max-w-none">
            
    


<div class="float">
<img src="https://nanx.me/image/google-deepmind-zyXg8_OOww8-unsplash.jpg" alt="Illustration from Google DeepMind. Artist: Martina Stiftinger." />
<div class="figcaption">Illustration from <a href="https://unsplash.com/photos/zyXg8_OOww8">Google DeepMind</a>. Artist: Martina Stiftinger.</div>
</div>
<p>Sometimes, large language models (LLMs) answer coding questions by
making up software behaviors or APIs that don’t exist.
A simple but effective strategy to minimize such hallucination problems is to
feed the exact, complete source code as context in the prompt.
For code organized in R packages, it is tedious to copy the file contents
and construct them into prompts manually.
Fortunately, you can use <a href="https://merck.github.io/pkglite/">pkglite</a>
to automate this process.</p>
<p>pkglite was originally <a href="https://nanx.me/blog/post/ectd-pkglite-paper/">designed</a>
to convert R packages to plain text files for regulatory submissions.
Here is a minimal example that shows how it can also help prompting LLMs
with the full source code of R packages.</p>
<pre class="r"><code>library(pkglite)

# Download and extract package source tarball
url &lt;- &quot;https://cran.r-project.org/src/contrib/ggsci_3.0.3.tar.gz&quot;
tarball &lt;- tempfile(fileext = &quot;.tar.gz&quot;)

curl::curl_download(url, destfile = tarball)
untar(tarball, exdir = tempdir())

# Set source package and output text file paths
pkg &lt;- file.path(tempdir(), &quot;ggsci&quot;)
txt &lt;- tempfile(fileext = &quot;.txt&quot;)

# Collate all source files under `R/` and `vignettes/`,
# exclude binary files and CSS files, and pack into a `.txt` file.
pkg |&gt;
  collate(file_r(), file_vignettes()) |&gt;
  prune(path = c(&quot;R/sysdata.rda&quot;, &quot;vignettes/custom.css&quot;)) |&gt;
  pack(output = txt)

# Read the `.txt` file and remove the metadata lines
pkg_content &lt;- readLines(txt)[-c(1:3)]

# Estimate # of tokens (1 token ~= 4 chars in English)
sum(nchar(pkg_content)) / 4</code></pre>
<p>In essence, three lines of code… is all you need.
For regular users, you can open the txt file and copy the content into the
chat application.
If too long, you can also split the file into multiple chunks and
send it in multiple prompts.</p>
<p>For developers, you can send it via the LLM vendor’s API. Example:</p>
<pre class="r"><code>library(gptstudio)

# Configure API key first
# &lt;https://github.com/MichelNivard/gptstudio#configuring-openai-api-key&gt;

prompt &lt;- paste0(
  &quot;Act as a senior R software engineer. &quot;,
  &quot;Below is the R package source for ggsci &quot;,
  &quot;in DCF (Debian Control File) format with the file path and content. &quot;,
  &quot;Based on the code and documentation, &quot;,
  &quot;build a custom discrete ggplot2 color scale that implements the &quot;,
  &quot;Bootstrap 5 color palette and allows custom color ordering.\n\n&quot;,
  paste0(pkg_content, collapse = &quot;\n&quot;)
)

result &lt;- chat(
  prompt,
  service = &quot;openai&quot;,
  model = &quot;gpt-4-turbo-preview&quot;,
  skill = &quot;advanced&quot;,
  task = &quot;coding&quot;
)

cat(result)</code></pre>
<style type="text/css">
details > summary {
    border: 1px solid #cbd5e1;
    border-radius: 0.25rem;
    padding: 1rem;
}
</style>
<details>
<summary>
Click here to expand a sample response from LLM
</summary>
<pre class="text"><code>To create a custom discrete ggplot2 color scale that implements the Bootstrap 5
color palette and allows for custom color ordering based on the `ggsci` DCF
description and codebase, we can follow a similar pattern to the existing
discrete scales in `ggsci`. Bootstrap 5 provides a set of color palettes
primarily intended for web development, including colors like primary,
secondary, success, danger, warning, info, light, and dark.

Assuming we&#39;d like to incorporate these colors directly from Bootstrap 5 into
a ggplot2 scale, we first need to define the Bootstrap 5 color codes.
For simplicity, let&#39;s stick to a subset: primary, danger, and success.
Bootstrap 5 color codes (at the time of my last knowledge update) are
as follows (assuming standard Bootstrap theme colors):

```r
bootstrap5_colors &lt;- c(
  &quot;primary&quot; = &quot;#0d6efd&quot;,
  &quot;danger&quot; = &quot;#dc3545&quot;,
  &quot;success&quot; = &quot;#198754&quot;
)
```

Now, we&#39;ll create a function that generates a custom palette function
incorporating Bootstrap 5 colors and allows for color reordering.
This function will be modelled after the structure of palette functions
provided in the `ggsci` package, for example, `pal_aaas()`, `pal_d3()`, etc.

```r
pal_bootstrap5 &lt;- function(palette = &quot;default&quot;, n = 3, alpha = 1, reverse = FALSE) {
  if(alpha &lt;= 0 | alpha &gt; 1) stop(&quot;alpha must be in (0, 1]&quot;)

  colors &lt;- bootstrap5_colors
  if(palette != &quot;default&quot;) {
    stop(&quot;Currently, only &#39;default&#39; palette is implemented.&quot;)
  }

  if(reverse) {
    colors &lt;- rev(colors)
  }

  if (length(colors) &gt; n) {
    colors &lt;- colors[seq_len(n)]
  }

  # Applying alpha transparency
  colors &lt;- grDevices::adjustcolor(colors, alpha.f = alpha)

  unname(colors)
}
```

Next, we create the `scale_color_` and `scale_fill_` functions to incorporate
these colors into ggplot2 plots.

```r
scale_color_bootstrap5 &lt;- function(..., palette = &quot;default&quot;, reverse = FALSE, alpha = 1) {
  discrete_scale(
    aesthetics = &quot;colour&quot;,
    scale_name = &quot;bootstrap5&quot;,
    palette = pal_bootstrap5(palette = palette, alpha = alpha, reverse = reverse),
    ...
  )
}

scale_fill_bootstrap5 &lt;- function(..., palette = &quot;default&quot;, reverse = FALSE, alpha = 1) {
  discrete_scale(
    aesthetics = &quot;fill&quot;,
    scale_name = &quot;bootstrap5&quot;,
    palette = pal_bootstrap5(palette = palette, alpha = alpha, reverse = reverse),
    ...
  )
}
```

This will enable the use of the Bootstrap 5 color palette in ggplot2,
with options for reverse ordering and adjusting transparency levels.
To use these scales, simply add them to a ggplot object with the
respective `scale_color_bootstrap5()` or `scale_fill_bootstrap5()` function.

This custom implementation takes inspiration from the structure and methodology
observed in the `ggsci` package, tailored for the Bootstrap 5 palette and
additional features like reversing the order and customizing transparency.</code></pre>
</details>
<p>
</p>
<p>Remember to check out the <a href="https://merck.github.io/pkglite/articles/">pkglite vignettes</a>.
They covered defining file packing scope specifications, curating file collections,
and more details on the output text file format. I wanted to make it as easy as
possible to run bidirectional R packages to plain text file conversion workflows
at scale.</p>
<div id="how-to-cite-pkglite" class="section level2">
<h2>How to cite pkglite</h2>
<p>If you find pkglite useful, you can cite it as below.</p>
<blockquote>
<p>Zhao, Y., Xiao, N., Anderson, K., &amp; Zhang, Y. (2023).
Electronic common technical document submission with analysis using R.
<em>Clinical Trials</em>, <strong>20</strong>(1), 89–92.
<a href="https://doi.org/10.1177/17407745221123244" class="uri">https://doi.org/10.1177/17407745221123244</a></p>
</blockquote>
<p>A BibTeX entry for LaTeX users is</p>
<pre class="text"><code>@article{zhao2023electronic,
  title   = {Electronic common technical document submission with analysis using {R}},
  author  = {Zhao, Yujie and Xiao, Nan and Anderson, Keaven and Zhang, Yilong},
  journal = {Clinical Trials},
  volume  = {20},
  number  = {1},
  pages   = {89--92},
  year    = {2023},
  doi     = {10.1177/17407745221123244}
}</code></pre>
</div>



        </div>

        
        <nav class="pagination-nav mt-10 mb-3" aria-label="Blog post navigation">
            <div class="navigation-btns">
                
                <a href="https://nanx.me/blog/post/stixfonts/" class="btn-nav btn-prev w-full">
                    <div class="btn-content">
                        <div class="pagination-nav-sublabel">Previous</div>
                        <div class="pagination-nav-label">&laquo; Use STIX Fonts in R Markdown and Quarto for Readability</div>
                    </div>
                </a>
                

                
                <a href="https://nanx.me/blog/post/ggsci-protr-msaenet-release-notes-2024/" class="btn-nav btn-next w-full">
                    <div class="btn-content">
                        <div class="pagination-nav-sublabel">Next</div>
                        <div class="pagination-nav-label">R Package Release Notes: ggsci, protr, and msaenet (Spring 2024) &raquo;</div>
                    </div>
                </a>
                
            </div>
        </nav>
        

    </article>
</main>

<section id="comments">
    <div class="py-3 content">
        <div class="mx-auto max-w-[65ch] w-full px-4 sm:px-6">
            <div class="comments">
                <script src="https://utteranc.es/client.js" repo="nanxstats/blog-comments" issue-term="pathname"
                    label="comment" theme="github-light" crossorigin="anonymous" async>
                    </script>
            </div>
        </div>
    </div>
</section>
<footer class="mt-20 mb-10 text-center font-sans text-sm text-zinc-500 tracking-wide">
    <div class="tufte-grid">
        <div class="flex flex-col items-center gap-4">
            <div class="flex flex-wrap items-center justify-center gap-x-4 gap-y-2">
                
                
                <a href="https://github.com/nanxstats" target="_blank" rel="noopener"
                    class="hover:text-accent transition-colors">GitHub</a>
                
                
                
                
                <a href="https://www.linkedin.com/in/nanxstats" target="_blank" rel="noopener"
                    class="hover:text-accent transition-colors">LinkedIn</a>
                
                
                <a href="https://bsky.app/profile/nanxstats.bsky.social" target="_blank" rel="noopener"
                    class="hover:text-accent transition-colors">Bluesky</a>
                
                
                <a href="https://twitter.com/nanxstats" target="_blank" rel="noopener"
                    class="hover:text-accent transition-colors">Twitter</a>
                
                
                
                <a href="https://nanx.me/colophon/" class="hover:text-accent transition-colors">Colophon</a>
                
                
            </div>

            
            <div class="mt-2">
                © 2026 Nan Xiao. All rights reserved.
            </div>
            
        </div>
    </div>
</footer>


    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/highlight.min.js"
        integrity="sha512-EBLzUL8XLl+va/zAsmXwS7Z2B1F9HUHkZwyS/VKwh3S7T/U0nF4BaU29EP/ZSf6zgiIxYAnKLu6bJ8dqpmX5uw=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/languages/r.min.js" defer></script>
    
    <script>
        window.addEventListener('load', function () {
            hljs.highlightAll();
        }, true);
    </script>
    

    

    
    
    
<script src="https://nanx.me/js/math-code.js"></script>
<script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js?config=TeX-MML-AM_CHTML"></script>


    
</body>

</html>