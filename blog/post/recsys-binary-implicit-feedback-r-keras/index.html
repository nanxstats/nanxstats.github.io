<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title> Prototyping a Recommender System for Binary Implicit Feedback Data with R and Keras - Nan Xiao | 肖楠 </title>
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="referrer" content="no-referrer">
    <meta name="description" content="" />

    
    <meta property="og:type" content="article" />
    <meta property="og:locale" content="en_US" />
    <meta property="og:site_name" content="Nan Xiao | 肖楠" />
    <meta property="og:url" content="https://nanx.me/blog/post/recsys-binary-implicit-feedback-r-keras/" />
    <meta property="og:title" content="Prototyping a Recommender System for Binary Implicit Feedback Data with R and Keras" />
    <meta property="og:description" content="" />
    <meta property="og:image" content="https://nanx.me/image/one-in-a-million-veronica-benavides.jpg" />
    <meta property="og:image:secure_url" content="https://nanx.me/image/one-in-a-million-veronica-benavides.jpg" />
    <meta property="article:published_time" content=" 2018-08-22T17:30:00Z" />
    <meta property="article:modified_time" content=" 2018-08-22T17:30:00Z" />
    <meta property="article:author" content="Nan Xiao" />

    
    <meta name="twitter:card" content="summary_large_image" />
    
    <meta name="twitter:site" content="@nanxstats">
    <meta name="twitter:creator" content="@nanxstats">
    
    <meta name="twitter:title" content="Prototyping a Recommender System for Binary Implicit Feedback Data with R and Keras" />
    <meta name="twitter:description" content="" />
    <meta name="twitter:image" content="https://nanx.me/image/one-in-a-million-veronica-benavides.jpg" />
    <meta name="twitter:image:alt" content="Prototyping a Recommender System for Binary Implicit Feedback Data with R and Keras" />

    
    <meta property="og:linkedin:actor" content="nanxstats" />

    <link rel="canonical" href="https://nanx.me/blog/post/recsys-binary-implicit-feedback-r-keras/">

    
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        serif: ['"Martina Plantijn"', 'Newsreader', 'Georgia', 'Cambria', '"Times New Roman"', 'Times', 'serif'],
                        sans: ['"Instrument Sans"', 'system-ui', '-apple-system', '"Segoe UI"', 'Roboto', '"Helvetica Neue"', 'Arial', 'sans-serif'],
                        mono: ['"Liga Noto Sans Mono"', 'ui-monospace', 'SFMono-Regular', '"SF Mono"', 'Menlo', 'Consolas', 'monospace'],
                    },
                    colors: {
                        paper: '#fdfdfd',
                        ink: '#1c1c1c',
                        accent: '#991b1b',  
                    },
                    typography: {
                        DEFAULT: {
                            css: {
                                maxWidth: 'none',
                                color: '#1c1c1c',
                                '--tw-prose-body': '#1c1c1c',
                                '--tw-prose-headings': '#1c1c1c',
                                '--tw-prose-links': '#991b1b',
                                '--tw-prose-bold': '#111827',
                                '--tw-prose-counters': '#71717a',
                                '--tw-prose-bullets': '#d4d4d8',
                                '--tw-prose-hr': '#e4e4e7',
                                '--tw-prose-quotes': '#1c1c1c',
                                '--tw-prose-quote-borders': '#d4d4d8',
                                '--tw-prose-captions': '#71717a',
                                '--tw-prose-code': '#1c1c1c',
                                '--tw-prose-pre-code': '#1c1c1c',
                                '--tw-prose-pre-bg': '#fdfdfd',
                                '--tw-prose-th-borders': '#d4d4d8',
                                '--tw-prose-td-borders': '#e4e4e7',
                                'pre': {
                                    color: '#1c1c1c',
                                    backgroundColor: '#fdfdfd !important',
                                    border: '1px solid #e4e4e7',
                                },
                                a: {
                                    color: '#991b1b',
                                    textDecoration: 'none',
                                    fontWeight: '400',
                                    borderBottom: '1px solid transparent',
                                    transition: 'border-color 0.2s ease, color 0.2s ease',
                                },
                                'a:hover': {
                                    color: '#991b1b !important',
                                    borderBottomColor: '#991b1b !important',
                                },
                                h1: { fontFamily: '"Instrument Sans", sans-serif', fontWeight: '500', letterSpacing: '-0.025em' },
                                h2: { fontFamily: '"Instrument Sans", sans-serif', fontWeight: '500', letterSpacing: '-0.025em', marginTop: '2em' },
                                h3: { fontFamily: '"Instrument Sans", sans-serif', fontWeight: '500' },
                                h4: { fontFamily: '"Instrument Sans", sans-serif', fontWeight: '500' },
                                blockquote: {
                                    fontStyle: 'italic',
                                    fontWeight: '400',
                                    borderLeftWidth: '2px',
                                },
                                'code::before': { content: 'none' },
                                'code::after': { content: 'none' },
                                ':not(pre) > code': {
                                    fontWeight: '400',
                                    color: '#1c1c1c !important',
                                    backgroundColor: '#f4f4f5 !important',
                                    padding: '0.2em 0.4em',
                                    borderRadius: '0.25rem',
                                    fontSize: '0.875em',
                                },
                            },
                        },
                    },
                },
            },
        }
    </script>

    <style type="text/tailwindcss">
        @layer utilities {
            .tufte-grid {
                display: grid;
                grid-template-columns: 1fr min(65ch, 100%) 1fr;
                column-gap: 2rem;
            }
            .tufte-grid > * {
                grid-column: 2;
            }
            .tufte-grid > .full-width {
                grid-column: 1 / -1;
            }
            .tufte-grid > .margin-note {
                grid-column: 3;
                font-family: "Instrument Sans", sans-serif;
                font-size: 0.875rem;
                line-height: 1.4;
                color: #52525b;  
                margin-top: 0.25rem;
            }
            @media (max-width: 1024px) {
                .tufte-grid {
                    grid-template-columns: 1rem 1fr 1rem;
                }
                .tufte-grid > .margin-note {
                    grid-column: 2;
                    margin-top: 0.5rem;
                    margin-bottom: 1rem;
                    padding-left: 1rem;
                    border-left: 2px solid #e4e4e7;
                }
            }
        }
    </style>

    <link rel="stylesheet" href="https://nanx.me/css/custom.css" />

    
    <link rel="stylesheet" href="https://nanx.me/css/textmate.css" />
    

    

    <link rel="shortcut icon"
        href="https://nanx.me/image/favicon.png">

    
</head>

<body class="bg-paper text-ink font-serif antialiased selection:bg-zinc-200">
    
<header class="py-8 lg:py-12 text-sm font-sans tracking-wide max-w-[67ch] mx-auto w-full px-4 sm:px-6">
    <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 sm:gap-0">
        <a href="https://nanx.me/" class="font-medium text-ink hover:text-accent transition-colors">
            Nan Xiao
        </a>
        <nav class="flex flex-wrap gap-4 sm:gap-6 text-zinc-600">
            
            
            <a class="text-ink font-medium"
                href="https://nanx.me/blog/">
                Blog
            </a>
            
            <a class="hover:text-accent transition-colors"
                href="https://nanx.me/software/">
                Software
            </a>
            
            <a class="hover:text-accent transition-colors"
                href="https://nanx.me/papers/">
                Papers
            </a>
            
            <a class="hover:text-accent transition-colors"
                href="https://nanx.me/talks/">
                Talks
            </a>
            
            <a class="hover:text-accent transition-colors"
                href="https://nanx.me/books/">
                Books
            </a>
            
            <a class="hover:text-accent transition-colors"
                href="https://nanx.me/about/">
                About
            </a>
            
        </nav>
    </div>
</header>

<main class="content my-10 lg:my-20 max-w-[65ch] mx-auto w-full px-4 sm:px-6">
    <article>
        <header class="mb-14">
            <h1 class="text-3xl lg:text-4xl font-sans tracking-tight text-ink font-medium mb-4">Prototyping a Recommender System for Binary Implicit Feedback Data with R and Keras</h1>

            <div class="text-zinc-500 font-sans text-sm tracking-wide">
                
                
                <span class="author" title="Nan Xiao">
                    Nan Xiao
                </span>
                
                

                <span class="date middot" title='Wed Aug 22 2018 17:30:00 UTC'>
                    August 22, 2018
                </span>

                <span class="reading-time middot">
                    5 min read
                </span>

                <div class="mt-8 flex flex-wrap gap-2">
                    
                    <a href="https://nanx.me/%20tags/deep-learning"
                        class="inline-flex items-center px-3 py-1 rounded-full bg-zinc-100 text-zinc-600 hover:bg-zinc-200 hover:text-ink transition-colors text-xs font-medium tracking-wide">
                        deep learning
                    </a>
                    
                    <a href="https://nanx.me/%20tags/neural-network"
                        class="inline-flex items-center px-3 py-1 rounded-full bg-zinc-100 text-zinc-600 hover:bg-zinc-200 hover:text-ink transition-colors text-xs font-medium tracking-wide">
                        neural network
                    </a>
                    
                    <a href="https://nanx.me/%20tags/recommender-system"
                        class="inline-flex items-center px-3 py-1 rounded-full bg-zinc-100 text-zinc-600 hover:bg-zinc-200 hover:text-ink transition-colors text-xs font-medium tracking-wide">
                        recommender system
                    </a>
                    
                    <a href="https://nanx.me/%20tags/collaborative-filtering"
                        class="inline-flex items-center px-3 py-1 rounded-full bg-zinc-100 text-zinc-600 hover:bg-zinc-200 hover:text-ink transition-colors text-xs font-medium tracking-wide">
                        collaborative filtering
                    </a>
                    
                    <a href="https://nanx.me/%20tags/implicit-feedback"
                        class="inline-flex items-center px-3 py-1 rounded-full bg-zinc-100 text-zinc-600 hover:bg-zinc-200 hover:text-ink transition-colors text-xs font-medium tracking-wide">
                        implicit feedback
                    </a>
                    
                    <a href="https://nanx.me/%20tags/keras"
                        class="inline-flex items-center px-3 py-1 rounded-full bg-zinc-100 text-zinc-600 hover:bg-zinc-200 hover:text-ink transition-colors text-xs font-medium tracking-wide">
                        Keras
                    </a>
                    
                    <a href="https://nanx.me/%20tags/r"
                        class="inline-flex items-center px-3 py-1 rounded-full bg-zinc-100 text-zinc-600 hover:bg-zinc-200 hover:text-ink transition-colors text-xs font-medium tracking-wide">
                        R
                    </a>
                    
                    
                    
                </div>
            </div>

        </header>

        <div class="prose prose-zinc max-w-none">
            
    
<script src="https://nanx.me/blog/post/recsys-binary-implicit-feedback-r-keras/index_files/header-attrs/header-attrs.js"></script>


<p>Ten years ago, the Netflix prize competition made a significant impact on recommender systems research. In the same time, such benchmark datasets, including <a href="https://grouplens.org/datasets/movielens/">MovieLens</a>, are a bit misleading: in reality, <a href="http://yifanhu.net/PUB/cf.pdf">implicit feedback</a> data, or binary implicit feedback data (someone interacted with something) could be the best we can have. One to five star ratings type of continuous response data could be challenging to get or impossible to measure.</p>
<div class="figure">
<img src="https://nanx.me/image/one-in-a-million-veronica-benavides.jpg" alt="" />
<p class="caption">Photo: <a href="https://unsplash.com/photos/W6NGECt_yE4">One in A Million</a> by Veronica Benavides</p>
</div>
<p>To do collaborative filtering with such data is a curse because the 0-1 entries in the matrix we want to decompose has far less information than a 1 to 5 score. While it is also a blessing because a binary classification is usually easier to do, compared to a real-valued regression — the information we need from either the features or latent factors is less than what a regression model requires. So intuitively, it balances out.</p>
<p>Now I’ve got <a href="https://nanx.me/blog/post/building-my-first-deep-learning-machine/">my new machine</a>. I decided to rapidly build a prototype recommender system for binary implicit feedback data With R and Keras. The algorithm should be elementary to implement with the frameworks and directly trainable on CPU or GPU.</p>
<div id="poor-mans-neural-collaborative-filtering" class="section level2">
<h2>Poor Man’s Neural Collaborative Filtering</h2>
<p>We will use the <a href="https://web.archive.org/web/20210927004551/https://www.netflixprize.com/assets/ProgressPrize2008_BellKor.pdf">simple SVD idea</a> popularized by the Netflix prize. Let’s say we have a <code>m x n</code> matrix <code>R</code> with binary values <code>r_{ui}</code>. We want to decompose it into a <code>m x k</code> matrix <code>P</code> and a <code>k x n</code> matrix <code>Q</code> with <code>k</code> latent factors each. The inner product <code>p_u x q_i</code> derived by latent representations <code>p_u</code> and <code>q_i</code> from <code>P</code> and <code>Q</code> will be used to predict <code>r_{ui}</code>. Everything is differentiable here so it can be optimized by gradient descent methods.</p>
<p>Some modifications for dealing with the binary implicit feedback data:</p>
<ul>
<li>Since <code>r_{ui}</code> is binary (0-1 valued), we will use the binary cross entropy loss (commonly used for classification) instead of the regression-oriented MSE losses.</li>
<li>As a remedy for the sparsity (or unbalanced classes) often presented in matrix <code>R</code>, we assign more weight to the less presented class (known interactions), which is necessarily “cost-sensitive learning”. Another possibility is to use random sampling to get different, much smaller sets of negative samples to balance the training data for each batch.</li>
<li>The inner product layer or the part before it is easily replaceable by arbitrary DNN architectures. I didn’t do it here though because I prefer to keep the model simple.</li>
</ul>
<p>As a reference, what we are trying to do here is similar to what <a href="https://dl.acm.org/doi/10.1145/3038912.3052569">He et al. (WWW 2017)</a> proposed, but even more straightforward. I call it “poor man’s neural collaborative filtering”.</p>
</div>
<div id="applications-to-quantitative-systems-pharmacology" class="section level2">
<h2>Applications to Quantitative Systems Pharmacology</h2>
<p>Let’s try this model with our data. The <a href="https://github.com/nanxstats/MEF">dataset</a> is from a <a href="https://doi.org/10.1002/psp4.12002">statistical methodology paper</a> we published in 2015. It contains 746 drugs and 817 adverse drug reactions (ADRs), with 24,803 known drug-ADR associations. This data can be represented by a 746 x 817 matrix with 0-1 entries, where 1 denotes for having a known association. It’s implicit feedback: we don’t know any non-association drug-ADR pairs here, and all the missing drug-ADR pairs (all the pairs other than the known associated pairs) are marked as 0. We are interested in predicting if there are any novel associations between all the missing drug-ADR pairs. If successful, we will be able to forecast if a specific drug has any potential but unreported side effects, which helps the clinical pharmacology and pharmacovigilance practice.</p>
<p>For our data, the model parameters are summarized below (only 15k parameters, yay):</p>
<pre><output>
_______________________________________________________________________________
Layer (type)                  Output Shape      Param #     Connected to
===============================================================================
input_1 (InputLayer)            (None, 1)         0
_______________________________________________________________________________
input_2 (InputLayer)            (None, 1)         0
_______________________________________________________________________________
embedding_1 (Embedding)       (None, 1, 10)       7460      input_1[0][0]
_______________________________________________________________________________
embedding_2 (Embedding)       (None, 1, 10)       8170      input_2[0][0]
_______________________________________________________________________________
flatten_1 (Flatten)             (None, 10)        0         embedding_1[0][0]
_______________________________________________________________________________
flatten_2 (Flatten)             (None, 10)        0         embedding_2[0][0]
_______________________________________________________________________________
dot_1 (Dot)                     (None, 1)         0         flatten_1[0][0]
                                                            flatten_2[0][0]
_______________________________________________________________________________
dense_1 (Dense)                 (None, 1)         2         dot_1[0][0]
===============================================================================
Total params: 15,632
Trainable params: 15,632
Non-trainable params: 0
_______________________________________________________________________________

</output></pre>
</div>
<div id="code-and-results" class="section level2">
<h2>Code and Results</h2>
<p>Let’s code it up with R + Keras and train it on GPU:</p>
<script src="https://gist.github.com/nanxstats/9a958fcd8c5a348a00116128afd7758f.js"></script>
<p>The key parameters to tune here are:</p>
<ul>
<li>The <code>optimizer</code>. We chose RMSProp since it gave us the most stable training results.</li>
<li>The number of latent factors <code>k</code>. We finally decided to use 5 because it is unlikely that one needs 50 factors to do this well. One probably also needs more layers for a larger <code>k</code>.</li>
<li>The <code>class_weight</code>. We tried a few from 1:1 to 500:1 and finally selected the 50:1 ratio.</li>
<li>The <code>batch_size</code>. Due to the sparsity of the matrix, this affects the performance.</li>
</ul>
<p>The loss and accuracy changes in each epoch are visualized below:</p>
<div class="figure">
<img src="r-keras-recsys-loss-accuracy.png" alt="" />
<p class="caption">Figure: Converges within 10 epochs (after some slight tuning). The accuracy is around 0.7.</p>
</div>
</div>
<div id="comments" class="section level2">
<h2>Comments</h2>
<p>We have just prototyped a recommender system with only a few lines of R code, thanks to the flexibility offered by a modern machine learning framework with automatic differentiation and off-the-shelf optimizers. Two interesting topics to explore:</p>
<ul>
<li><strong>Model architecture</strong>. The barebone model here is easily extensible to build <strong>hybrid</strong> recommender systems as we did in our 2015 paper. Such extensions can be defined as <a href="https://www.jmlr.org/papers/volume13/chen12a/chen12a.pdf">feature-based matrix factorization</a>, meaning we can further incorporate features for the drugs and ADRs to improve the predictive performance. One can simply put them in a neural net architecture and let them play together with the latent factors learned here.</li>
<li><strong>Loss function</strong>. It is possible to try more loss functions, such as the <a href="https://github.com/maciejkula/triplet_recommendations_keras">triplet loss</a> designed explicitly for one-class classification or metric learning problems.</li>
</ul>
<p>Here is the <a href="https://github.com/nanxstats/deep-learning-recipes">GitHub repo</a> for the R code.</p>
</div>



        </div>

        
        <nav class="pagination-nav mt-10 mb-3" aria-label="Blog post navigation">
            <div class="navigation-btns">
                
                <a href="https://nanx.me/blog/post/building-my-first-deep-learning-machine/" class="btn-nav btn-prev w-full">
                    <div class="btn-content">
                        <div class="pagination-nav-sublabel">Previous</div>
                        <div class="pagination-nav-label">&laquo; Building My First Deep Learning Machine</div>
                    </div>
                </a>
                

                
                <a href="https://nanx.me/blog/post/how-a-financial-crisis-started/" class="btn-nav btn-next w-full">
                    <div class="btn-content">
                        <div class="pagination-nav-sublabel">Next</div>
                        <div class="pagination-nav-label">How a Financial Crisis Started &raquo;</div>
                    </div>
                </a>
                
            </div>
        </nav>
        

    </article>
</main>

<section id="comments">
    <div class="py-3 content">
        <div class="mx-auto max-w-[65ch] w-full px-4 sm:px-6">
            <div class="comments">
                <script src="https://utteranc.es/client.js" repo="nanxstats/blog-comments" issue-term="pathname"
                    label="comment" theme="github-light" crossorigin="anonymous" async>
                    </script>
            </div>
        </div>
    </div>
</section>
<footer class="mt-20 mb-10 text-center font-sans text-sm text-zinc-500 tracking-wide">
    <div class="tufte-grid">
        <div class="flex flex-col items-center gap-4">
            <div class="flex flex-wrap items-center justify-center gap-x-4 gap-y-2">
                
                
                <a href="https://github.com/nanxstats" target="_blank" rel="noopener"
                    class="hover:text-accent transition-colors">GitHub</a>
                
                
                
                
                <a href="https://www.linkedin.com/in/nanxstats" target="_blank" rel="noopener"
                    class="hover:text-accent transition-colors">LinkedIn</a>
                
                
                <a href="https://bsky.app/profile/nanxstats.bsky.social" target="_blank" rel="noopener"
                    class="hover:text-accent transition-colors">Bluesky</a>
                
                
                <a href="https://twitter.com/nanxstats" target="_blank" rel="noopener"
                    class="hover:text-accent transition-colors">Twitter</a>
                
                
                
                <a href="https://nanx.me/colophon/" class="hover:text-accent transition-colors">Colophon</a>
                
                
            </div>

            
            <div class="mt-2">
                © 2026 Nan Xiao. All rights reserved.
            </div>
            
        </div>
    </div>
</footer>


    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/highlight.min.js"
        integrity="sha512-EBLzUL8XLl+va/zAsmXwS7Z2B1F9HUHkZwyS/VKwh3S7T/U0nF4BaU29EP/ZSf6zgiIxYAnKLu6bJ8dqpmX5uw=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/languages/r.min.js" defer></script>
    
    <script>
        window.addEventListener('load', function () {
            hljs.highlightAll();
        }, true);
    </script>
    

    

    
    
    

    
</body>

</html>