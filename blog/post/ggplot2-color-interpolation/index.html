<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title> Adaptive ggplot2 Color Scales with Color Interpolation - Nan Xiao | 肖楠 </title>
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="referrer" content="no-referrer">
    <meta name="description" content="Create discrete ggplot2 color scales that are adaptive to the number of categories in the data." />
    <meta property="og:site_name" content="Nan Xiao | 肖楠" />
    <meta property="og:locale" content="en_US" />
    <meta property="og:type" content="article" />
    <meta property="og:url" content="https://nanx.me/blog/post/ggplot2-color-interpolation/" />
    <meta property="og:title" content="Adaptive ggplot2 Color Scales with Color Interpolation" />
    <meta property="og:image" content="https://nanx.me/image/mateo-giraud-wtBex4wQw60-unsplash.jpg" />
    <meta property="og:description" content="Create discrete ggplot2 color scales that are adaptive to the number of categories in the data." />

    <meta name="twitter:card" content="summary_large_image" />
    
    <meta name="twitter:site" content="@nanxstats">
    <meta name="twitter:creator" content="@nanxstats">
    
    <meta name="twitter:title" content="Adaptive ggplot2 Color Scales with Color Interpolation" />
    <meta name="twitter:description" content="Create discrete ggplot2 color scales that are adaptive to the number of categories in the data." />
    <meta name="twitter:image" content="https://nanx.me/image/mateo-giraud-wtBex4wQw60-unsplash.jpg" />

    <link rel="canonical" href="https://nanx.me/blog/post/ggplot2-color-interpolation/">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css" integrity="sha512-GQGU0fMMi238uA+a/bdWJfpUGKUkBdgfFdgBm72SUQ6BeyWjoY/ton0tEjH+OSH9iP4Dfh+7HM0I9f5eR0L/4w==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <link rel="stylesheet" href="https://nanx.me/css/custom.css" />

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.3.1/styles/github.min.css" integrity="sha512-0aPQyyeZrWj9sCA46UlmWgKOP0mUipLQ6OZXu8l4IcAmD2u31EPEy9VcIMvl7SoAaKe8bLXZhYoMaE/in+gcgA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    

    

    <link rel="shortcut icon"
        href="https://nanx.me/image/favicon.png">

    
    <link href="https://nanx.me/index.xml" rel="alternate" type="application/rss+xml" title="Nan Xiao | 肖楠" />
    
</head>

<body>
    
<div class="my-4 my-lg-5 header">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-sm-12 col-lg-6">
                <div class="d-flex align-items-center">
                    <div class="flex-shrink-0">
                        
                        <a href="https://nanx.me/">
                            <img class="logo img-fluid d-block rounded-circle"
                                src="https://nanx.me/image/nanxiao.jpg" alt="Portrait of Nan Xiao">
                        </a>
                        
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <a href="https://nanx.me/">
                            <h1 class="name">Nan Xiao</h1>
                        </a>

                        <ul class="nav nav-primary">
                            
                            <li class="nav-item">
                                <a class="nav-link text-blog"
                                    href="https://nanx.me/blog/">
                                    
                                    Blog
                                </a>
                            </li>
                            
                            <li class="nav-item">
                                <a class="nav-link text-software"
                                    href="https://nanx.me/software/">
                                    
                                    Software
                                </a>
                            </li>
                            
                            <li class="nav-item">
                                <a class="nav-link text-papers"
                                    href="https://nanx.me/papers/">
                                    
                                    Papers
                                </a>
                            </li>
                            
                            <li class="nav-item">
                                <a class="nav-link text-talks"
                                    href="https://nanx.me/talks/">
                                    
                                    Talks
                                </a>
                            </li>
                            
                            <li class="nav-item">
                                <a class="nav-link text-books"
                                    href="https://nanx.me/books/">
                                    
                                    Books
                                </a>
                            </li>
                            
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="content">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-sm-12 col-lg-6">
                <h1 class="blog-post-title">Adaptive ggplot2 Color Scales with Color Interpolation</h1>

                <div class="mb-md-4 meta">
                    
                    
                    <span class="author" title="Nan Xiao">
                        Nan Xiao
                    </span>
                    
                    

                    <span class="date middot" title='Wed Apr 6 2022 01:30:00 UTC'>
                        2022-04-06
                    </span>

                    <span class="reading-time middot">
                        3 min read
                    </span>

                    <div class="d-none d-md-inline tags">
                        <ul class="list-unstyled d-inline">
                            
                            <li class="d-inline middot">
                                <a href="https://nanx.me/tags/r">R</a>
                            </li>
                            
                            <li class="d-inline middot">
                                <a href="https://nanx.me/tags/ggplot2">ggplot2</a>
                            </li>
                            
                            <li class="d-inline middot">
                                <a href="https://nanx.me/tags/color-scales">color scales</a>
                            </li>
                            
                            <li class="d-inline middot">
                                <a href="https://nanx.me/tags/color-interpolation">color interpolation</a>
                            </li>
                            
                        </ul>
                    </div>

                    <div class="d-none d-md-inline tags">
                        <ul class="list-unstyled d-inline">
                            
                            
                        </ul>
                    </div>
                </div>

                <div class="markdown blog-post-content">
                    
    


<div class="figure">
<img src="https://nanx.me/image/mateo-giraud-wtBex4wQw60-unsplash.jpg" alt="" />
<p class="caption">Photo by <a href="https://unsplash.com/photos/wtBex4wQw60">Mateo Giraud</a>.</p>
</div>
<p>My R package <a href="https://github.com/nanxstats/ggsci">ggsci</a> has included a few
popular discrete color palettes.
The colors values in these palettes are not automatically generated from a
color space but hand-picked instead, often containing only five to ten
distinct colors.
A <a href="https://github.com/nanxstats/ggsci/issues/8">frequent question</a> from the
users is: What should I do when the colors are running out due to a more
significant number of categories in the data?</p>
<p>Better approaches may exist, but an <em>ad hoc</em> method is to interpolate
the color values to generate more colors based on the number of categories.
Here, I will demonstrate how to construct such an “adaptive” color palette
generator and the ggplot2 color scales for all ggsci color palettes.</p>
<div class="alert alert-warning" role="alert">
<p>⚠️ It might be better not to encode too many categories in different colors.
Please see the recommendations from the
<a href="https://clauswilke.com/dataviz/color-pitfalls.html">common pitfalls of color use</a>
chapter in the <em>Fundamentals of Data Visualization</em> book by Claus O. Wilke.</p>
</div>
<p>We start with the color interpolation logic as a
<a href="https://adv-r.hadley.nz/function-factories.html">function factory</a>
and leverage <code>grDevices::colorRampPalette()</code>.</p>
<pre class="r"><code>#&#39; Adaptive palette (discrete)
#&#39;
#&#39; Create a discrete palette that will use the first `n` colors from
#&#39; the supplied color values when the palette has enough colors.
#&#39; Otherwise, use an interpolated color palette.
#&#39;
#&#39; @param values Color values.
pal_ramp &lt;- function(values) {
  force(values)
  function(n) {
    if (n &lt;= length(values)) {
      values[seq_len(n)]
    } else {
      colorRampPalette(values, alpha = TRUE)(n)
    }
  }
}</code></pre>
<p>Then, we create a color palette generator function,
similar to the existing color palette generator functions in ggsci.
The main difference here is that you can access and interpolate the raw color
values of any palettes in ggsci.</p>
<pre class="r"><code>#&#39; Adaptive color palette generator
#&#39;
#&#39; Adaptive color palette generator for ggsci color palettes using `pal_ramp()`.
#&#39;
#&#39; @param name Color palette name in ggsci
#&#39; @param palette Color palette type in ggsci
#&#39; @param alpha Transparency level, a real number in (0, 1].
#&#39;
#&#39; @details See `names(ggsci:::ggsci_db)` for all color palette names in ggsci.
#&#39; See `names(ggsci:::ggsci_db$&quot;pal&quot;)` for available palette types under
#&#39; the palette `pal`.
pal_adaptive &lt;- function(name, palette, alpha = 1) {
  if (alpha &gt; 1L | alpha &lt;= 0L) stop(&quot;alpha must be in (0, 1]&quot;)

  raw_cols &lt;- ggsci:::ggsci_db[[name]][[palette]]
  raw_cols_rgb &lt;- col2rgb(raw_cols)
  alpha_cols &lt;- rgb(
    raw_cols_rgb[1L, ], raw_cols_rgb[2L, ], raw_cols_rgb[3L, ],
    alpha = alpha * 255L, names = names(raw_cols),
    maxColorValue = 255L
  )

  pal_ramp(unname(alpha_cols))
}</code></pre>
<p>Finishing up by creating the ggplot2 color scales as usual.</p>
<pre class="r"><code>#&#39; Adaptive color scales
#&#39;
#&#39; @inheritParams pal_adaptive
#&#39; @param ... additional parameters for [ggplot2::discrete_scale()].
scale_color_adaptive &lt;- function(name, palette, alpha = 1, ...) {
  ggplot2::discrete_scale(&quot;colour&quot;, name, pal_adaptive(name, palette, alpha), ...)
}

scale_fill_adaptive &lt;- function(name, palette, alpha = 1, ...) {
  ggplot2::discrete_scale(&quot;fill&quot;, name, pal_adaptive(name, palette, alpha), ...)
}</code></pre>
<p>Feels easy enough? Let’s test it in the wild with some
high-cardinality data.</p>
<p>We trained some <a href="https://github.com/nanxstats/exp2vec">tissue-specific gene embeddings on GTEx data using GloVe</a>.
The embeddings are then projected to a 2D plane with t-SNE.</p>
<pre class="r"><code>word_vectors &lt;- readRDS(url(
  &quot;https://raw.githubusercontent.com/nanxstats/exp2vec/main/output/Pancreas_embedding.rds&quot;
))
tsne_out &lt;- readRDS(url(
  &quot;https://raw.githubusercontent.com/nanxstats/exp2vec/main/output/Pancreas_tsne.rds&quot;
))</code></pre>
<p>Run k-means clustering on the projected coordinates and get 15 clusters:</p>
<pre class="r"><code>set.seed(42)
cl &lt;- kmeans(word_vectors, centers = 15, iter.max = 20)
df &lt;- cbind(as.data.frame(tsne_out$Y), as.factor(cl$cluster))
names(df) &lt;- c(&quot;x&quot;, &quot;y&quot;, &quot;cluster&quot;)</code></pre>
<p>The <a href="https://nanx.me/ggsci/reference/pal_nejm.html">original color palette</a>
only has 8 colors, but it will work fine here:</p>
<pre class="r"><code>ggplot2::ggplot(df, ggplot2::aes(x = x, y = y)) +
  ggplot2::geom_point(ggplot2::aes(colour = cluster), alpha = 0.5, size = 1) +
  cowplot::theme_minimal_grid() +
  scale_color_adaptive(name = &quot;nejm&quot;, palette = &quot;default&quot;)</code></pre>
<p><img src="https://nanx.me/blog/post/ggplot2-color-interpolation/index_files/figure-html/unnamed-chunk-7-1.png" width="100%" /></p>
<p>That’s all, folks.</p>



                </div>

                
                <div class="navigation">
                    <div class="row">
                        <div class="col-12 col-lg-6">
                            
                            <div class="mt-4 text-start">
                                <a href="https://nanx.me/blog/post/shiny-fcp-loader/">« Architecting Large Shiny Apps with Minimal First Contentful Paint Time</a>
                            </div>
                            
                        </div>
                        <div class="col-12 col-lg-6">
                            
                            <div class="mt-4 text-end">
                                <a href="https://nanx.me/blog/post/dt-news-list/">Building Paginated News Lists in R Markdown and Shiny with DT »</a>
                            </div>
                            
                        </div>
                    </div>
                </div>
                
            </div>
        </div>
    </div>
</div>

<section id="comments">
    <div class="py-3 content">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-sm-12 col-lg-6">
                    <div class="comments">
                        <script src="https://utteranc.es/client.js" repo="nanxstats/blog-comments"
                            issue-term="pathname" label="comment" theme="github-light" crossorigin="anonymous" async>
                            </script>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
<div class="footer mt-5">
    <div class="container">

        <div class="row justify-content-center">
            <div class="col-sm-12 col-lg-6">
                <hr>
            </div>
        </div>

        <div class="row justify-content-center">
            <div class="col-sm-12 col-lg-6">
                
                <div class="site-copyright">
                    © 2011–2022 Nan Xiao
                </div>
                
            </div>
        </div>
        <div class="row justify-content-center mt-1 mb-5">
            <div class="col-sm-12 col-lg-6">
                <div class="site-social">
                    <ul>
                        

                        
                        <li><a href="https://github.com/nanxstats" target="_blank"
                                rel="noopener">GitHub</a></li>
                        

                        

                        

                        
                        <li><a href="https://twitter.com/nanxstats" target="_blank"
                                rel="noopener">Twitter</a></li>
                        

                        
                        <li><a href="https://www.linkedin.com/in/nanxstats" target="_blank"
                                rel="noopener">LinkedIn</a></li>
                        

                        
                        <li><a href="https://nanx.me/colophon/">Colophon</a></li>
                        

                        
                        <li><a href="https://nanx.me/index.xml" class="mr-0">RSS</a></li>
                        

                        
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>


    

    
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.3.1/highlight.min.js" integrity="sha512-Pbb8o120v5/hN/a6LjF4N4Lxou+xYZ0QcVF8J6TWhBbHmctQWd8O6xTDmHpE/91OjPzCk4JRoiJsexHYg4SotQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
        
            <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.3.1/languages/r.min.js" defer></script>
        
        <script>
            window.addEventListener('load', function() {
                hljs.highlightAll();
            }, true);
        </script>
    

    

    
    
        
<script src="https://nanx.me/js/math-code.js"></script>
<script async src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script>


    
</body>

</html>
