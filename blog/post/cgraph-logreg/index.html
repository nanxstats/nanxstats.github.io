<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title> Building Regularized Logistic Regressions from Scratch with Computational Graphs in R - Nan Xiao | 肖楠 </title>
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="referrer" content="no-referrer">
    <meta name="description" content="" />
    <meta property="og:site_name" content="Nan Xiao | 肖楠" />
    <meta property="og:locale" content="en_US" />
    <meta property="og:type" content="article" />
    <meta property="og:url" content="https://nanx.me/blog/post/cgraph-logreg/" />
    <meta property="og:title" content="Building Regularized Logistic Regressions from Scratch with Computational Graphs in R" />
    <meta property="og:image" content="https://nanx.me/image/downhill-into-the-forest-joakim-honkasalo.jpg" />
    <meta property="og:description" content="" />

    <meta name="twitter:card" content="summary_large_image" />
    
    <meta name="twitter:site" content="@nanxstats">
    <meta name="twitter:creator" content="@nanxstats">
    
    <meta name="twitter:title" content="Building Regularized Logistic Regressions from Scratch with Computational Graphs in R" />
    <meta name="twitter:description" content="" />
    <meta name="twitter:image" content="https://nanx.me/image/downhill-into-the-forest-joakim-honkasalo.jpg" />

    <link rel="canonical" href="https://nanx.me/blog/post/cgraph-logreg/">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha256-YLGeXaapI0/5IgZopewRJcFXomhRMlYYjugPLSyNjTY=" crossorigin="anonymous" />

    <link rel="stylesheet" href="https://nanx.me/css/custom.css" />

    
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.14.2/styles/tomorrow.min.css" integrity="sha256-0QU8ry64q+N6YBIEF/6XF6vUeF15gbNO4tLS6ikk0FI=" crossorigin="anonymous" />
    

    

    <link rel="shortcut icon"
        href="https://nanx.me/image/favicon.png">

    
        <link href="https://nanx.me/index.xml" rel="alternate" type="application/rss+xml" title="Nan Xiao | 肖楠" />
    
</head>

<body>
    
    <div class="my-4 my-md-5 header">
    <div class="container">
        <div class="row">
            <div class="col-auto offset-md-1 d-none d-md-block">
                
                    <a href="https://nanx.me/">
                        <img class="ml-md-4 logo img-fluid d-block rounded-circle" src="https://nanx.me/image/nanxiao.jpg" alt="logo">
                    </a>
                
            </div>
            <div class="col-auto align-self-center mr-auto">
                <a href="https://nanx.me/">
                    <h1 class="name">Nan Xiao</h1>
                </a>

                <ul class="nav nav-primary">
                    
                        <li class="nav-item">
                            <a class="text-uppercase nav-link text-software" href="https://nanx.me/software/">
                                
                                Software
                            </a>
                        </li>
                    
                        <li class="nav-item">
                            <a class="text-uppercase nav-link text-papers" href="https://nanx.me/papers/">
                                
                                Papers
                            </a>
                        </li>
                    
                        <li class="nav-item">
                            <a class="text-uppercase nav-link text-books" href="https://nanx.me/books/">
                                
                                Books
                            </a>
                        </li>
                    
                        <li class="nav-item">
                            <a class="text-uppercase nav-link text-talks" href="https://nanx.me/talks/">
                                
                                Talks
                            </a>
                        </li>
                    
                        <li class="nav-item">
                            <a class="text-uppercase nav-link text-blog" href="https://nanx.me/blog/">
                                
                                Blog
                            </a>
                        </li>
                    

                    
                </ul>

            </div>
        </div>
    </div>
</div>


    <div class="content">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-sm-12 col-md-10">
                    <h1 class="mx-0 mx-md-4 blog-post-title">Building Regularized Logistic Regressions from Scratch with Computational Graphs in R</h1>

                    <div class="mb-md-4 meta">
                        
                            
                                <span class="author" title="Nan Xiao">
                                    Nan Xiao
                                </span>
                            
                        

                        <span class="date middot" title='Sun Oct 6 2019 00:30:00 UTC'>
                            2019-10-06
                        </span>

                        <span class="reading-time middot">
                            4 minute read
                        </span>

                        <div class="d-none d-md-inline tags">
                            <ul class="list-unstyled d-inline">
                                
                                    <li class="d-inline middot">
                                        <a href="https://nanx.me/tags/computational-graph">computational graph</a>
                                    </li>
                                
                                    <li class="d-inline middot">
                                        <a href="https://nanx.me/tags/automatic-differentiation">automatic differentiation</a>
                                    </li>
                                
                                    <li class="d-inline middot">
                                        <a href="https://nanx.me/tags/logistic-regression">logistic regression</a>
                                    </li>
                                
                                    <li class="d-inline middot">
                                        <a href="https://nanx.me/tags/linear-models">linear models</a>
                                    </li>
                                
                                    <li class="d-inline middot">
                                        <a href="https://nanx.me/tags/regularization">regularization</a>
                                    </li>
                                
                                    <li class="d-inline middot">
                                        <a href="https://nanx.me/tags/cgraph">cgraph</a>
                                    </li>
                                
                                    <li class="d-inline middot">
                                        <a href="https://nanx.me/tags/r">R</a>
                                    </li>
                                
                            </ul>
                        </div>

                        <div class="d-none d-md-inline tags">
                            <ul class="list-unstyled d-inline">
                                
                                
                            </ul>
                        </div>
                    </div>

                    <div class="markdown">
                        
    
<script src="https://nanx.me/rmarkdown-libs/header-attrs/header-attrs.js"></script>


<p>The R package built for this post is available on GitHub: <a href="https://github.com/nanxstats/logreg">nanxstats/logreg</a>.</p>
<p><strong>Update 2020-02-11</strong>: there has been some major API <a href="https://github.com/triepels/cgraph/blob/master/NEWS.md">updates and improvements</a> since cgraph 5.0.0. The logreg package is now <a href="https://github.com/nanxstats/logreg/pull/1">updated</a> to reflect these changes. The code example in this post is updated, too.</p>
<p>As one of the cornerstones for deep learning frameworks, automatic differentiation was briefly <a href="https://nanx.me/blog/post/10-things-matter-in-deep-learning-1/">mentioned</a> in our previous post. Today let’s focus on the other important piece: the computational graph. I’m only able to write something about this, thanks to <a href="https://github.com/triepels/">Ron Triepels</a>, the author of the recently published R package <a href="https://github.com/triepels/cgraph">cgraph</a>. This package offers a decent, minimalist implementation for computational graphs and automatic differentiation in native C and R.</p>
<div class="figure">
<img src="https://nanx.me/image/downhill-into-the-forest-joakim-honkasalo.jpg" alt="" />
<p class="caption">Downhill into the forest. Photo by <a href="https://unsplash.com/photos/BT9e-1olEkY">Joakim Honkasalo</a>.</p>
</div>
<p>The computational graph is a useful abstraction/framework for describing and executing computational workflows for data. In many cases, the workflows/pipelines are composed of very reusable components, such as all the types of layers in neural networks. Besides machine learning applications, another interesting example is the <a href="https://www.commonwl.org/">Common Workflow Language (CWL)</a>. CWL is widely used for describing bioinformatics workflows. The components in the workflow described in YAML or JSON formats are parsed to create a computational graph to run through later.</p>
<p>To me, one of the benefits of using computational graphs is that you will notice the issues immediately if there is an error compiling the graph before even running things, say, mistakes were made when describing the workflow. This may help enforce and improve code quality and reproducibility. Plus, The modularized computational components makes it particularly easy to prototype new machine learning algorithms, just like legos. On the performance side, since the data and computation flow is predictable, many aggressive optimizations are possible, for example, on parallelization.</p>
<p>To experience how powerful computational graph + automatic differentiation is for solving classical machine learning problems, I took a few hours to use cgraph and built an R package <a href="https://github.com/nanxstats/logreg">logreg</a>. I implemented three methods here:</p>
<ul>
<li>Logistic regression</li>
<li>Logistic regression with the ridge (<span class="math inline">\(\ell_2\)</span>) penalty</li>
<li>Logistic regression with the <a href="http://www3.stat.sinica.edu.tw/statistica/oldpdf/A23n220.pdf">seamless-<span class="math inline">\(\ell_0\)</span> (SELO) penalty</a>, a differentiable approximation of the <span class="math inline">\(\ell_0\)</span> penalty.</li>
</ul>
<p>Although these methods could be implemented very differently before, the core implementation with cgraph is surprisingly similar: pretty much just replacing the loss/cost functions, as is shown below (SELO). Check out this <a href="https://nanx.me/logreg/articles/logreg.html">vignette</a> for test examples, and please feel free to leave me a message if you find any bugs in the code.</p>
<pre class="r"><code># initialize graph
graph &lt;- cg_graph(eager = FALSE)

# initialize input (X), target (y)
input &lt;- cg_constant(x, &quot;input&quot;)
target &lt;- cg_constant(y, &quot;target&quot;)

# intialize parameters (beta, alpha)
parms &lt;- list(
  beta = cg_parameter(initialize_glorot_normal(ncol(x), 1), &quot;beta&quot;),
  alpha = cg_parameter(initialize_constant(0), &quot;alpha&quot;)
)

# define the model (yhat = beta X + alpha)
output &lt;- cg_sigmoid(cg_linear(input, parms$beta, parms$alpha), &quot;output&quot;)

# define the selo loss (y, yhat, beta)
loss &lt;- cg_add(
  cg_mean(crossentropy(target, output)),
  cg_mean(cg_ln((cg_abs(parms$beta) / (cg_abs(parms$beta) + tau)) + 1)) / log(2),
  &quot;loss&quot;
)

# track errors
error &lt;- rep(0, n_epochs)

# optimize parameters via sgd
for (i in 1:n_epochs) {
  cg_graph_forward(graph, loss)
  cg_graph_backward(graph, loss)
  for (parm in parms) parm$value &lt;- parm$value - learning_rate * parm$grad
  error[i] &lt;- loss$value
}</code></pre>
<p>On the other hand, treating code as graph data also comes with some side effects and limitations. Lazy evaluation on a static computational graph makes it almost impossible to do real-time debugging and writing loops/conditionals, as these things cannot be naturally represented in a static graph. As I’m writing this, TensorFlow 2.0 is released and switched to eager execution by default, which employs a tape recorder + dynamic computational graph, following the PyTorch approach. Automatic differentiation also requires the model to be designed as differentiable, or differentiable with approximations, which is unfortunate for tree-based models.</p>
<p>In the end, I feel using computational graphs is still overwhelmingly beneficial. With more low-level APIs to access computational graphs in R, we will be able to essentially build the “TensorFlow” or “Keras” for our domains of interest in R. There are so many exciting research topics waiting there for our exploration, after all.</p>



                    </div>

                    
                        <div class="navigation">
                            <div class="row">
                                <div class="col-12 col-md-6">
                                    
                                        <div class="mx-0 mx-md-4 mt-4 text-left">
                                            <a href="https://nanx.me/blog/post/peak-experience/">« Peak Experience</a>
                                        </div>
                                    
                                </div>
                                <div class="col-12 col-md-6">
                                    
                                        <div class="mx-0 mx-md-4 mt-4 text-right">
                                            <a href="https://nanx.me/blog/post/tidycwl-biocompute/">New Packages on CRAN: tidycwl and biocompute »</a>
                                        </div>
                                    
                                </div>
                            </div>
                        </div>
                    
                </div>
            </div>
        </div>
    </div>

    <section id="comments">

      <div class="py-3 content">
            <div class="container">
                  <div class="row justify-content-center">
                        <div class="col-sm-12 col-md-10">
                              <div class="comments">
                                    <div id="disqus_thread"></div>
                              </div>
                        </div>
                  </div>
            </div>
      </div>

      <script type="text/javascript">
            (function () {
                  
                  
                  if (window.location.hostname == "localhost")
                        return;

                  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                  var disqus_shortname = 'nan-xiao-blog';
                  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
      </script>
      <noscript>
            Please enable JavaScript to view the
            <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
      </noscript>
</section>
    <div class="my-4 footer">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-sm-12 col-md-5">
                
                    <div class="mx-0 mx-md-4 text-left">
                        
                            <a href="https://nanx.me/">© 2019 Nan Xiao</a>
                        
                    </div>
                
            </div>
            <div class="col-sm-12 col-md-5">
                <div class="mx-0 mx-md-4 text-right">
                    
                        <a href="https://github.com/nanxstats" target="_blank">
                            <img class="icon" src="https://nanx.me/img/github.svg" alt="GitHub" />
                        </a>
                    

                    

                    

                    
                    <a href="https://twitter.com/nanxstats" target="_blank">
                        <img class="icon" src="https://nanx.me/img/twitter.svg" alt="Twitter" />
                    </a>
                    

                    
                    <a href="https://www.linkedin.com/in/nanxstats" target="_blank">
                        <img class="icon" src="https://nanx.me/img/linkedin.svg" alt="LinkedIn" />
                    </a>
                    

                    

                    

                    

                    
                    <a href="mailto:me@nanx.me">
                        <img class="icon" src="https://nanx.me/img/email.svg" alt="Email" />
                    </a>
                    

                    
                        <a href="https://nanx.me/index.xml" class="mr-0">
                            <img class="icon" src="https://nanx.me/img/rss.svg" alt="RSS" />
                        </a>
                    

                    
                </div>
            </div>
        </div>
    </div>
</div>



    

    
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.14.2/highlight.min.js" integrity="sha256-sNPiigbfSkqUzMc5rgrdztLnneCMAp6W9wetJUZu9Zw=" crossorigin="anonymous"></script>
        
        <script>
            window.addEventListener('load', function() {
                hljs.initHighlighting();
            }, true);
        </script>
    

    

    
    
        
<script src="https://nanx.me/js/math-code.js"></script>
<script async src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script>


    
</body>

</html>
