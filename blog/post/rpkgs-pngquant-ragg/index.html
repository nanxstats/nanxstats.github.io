<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title> Compressing PNG Output for R Packages with pngquant and ragg - Nan Xiao | 肖楠 </title>
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="referrer" content="no-referrer">
    <meta name="description" content="Optimize PNG output sizes in R packages using pngquant and ragg, ensuring CRAN check compliance without compromising image quality.
" />

    
    <meta property="og:type" content="article" />
    <meta property="og:locale" content="en_US" />
    <meta property="og:site_name" content="Nan Xiao | 肖楠" />
    <meta property="og:url" content="https://nanx.me/blog/post/rpkgs-pngquant-ragg/" />
    <meta property="og:title" content="Compressing PNG Output for R Packages with pngquant and ragg" />
    <meta property="og:description" content="Optimize PNG output sizes in R packages using pngquant and ragg, ensuring CRAN check compliance without compromising image quality.
" />
    <meta property="og:image" content="https://nanx.me/image/jametlene-reskp-hiu5XMrTvn0-unsplash.jpg" />
    <meta property="og:image:secure_url" content="https://nanx.me/image/jametlene-reskp-hiu5XMrTvn0-unsplash.jpg" />
    <meta property="article:published_time" content=" 2023-04-09T00:30:00Z" />
    <meta property="article:modified_time" content=" 2023-04-09T00:30:00Z" />
    <meta property="article:author" content="Nan Xiao" />

    
    <meta name="twitter:card" content="summary_large_image" />
    
    <meta name="twitter:site" content="@nanxstats">
    <meta name="twitter:creator" content="@nanxstats">
    
    <meta name="twitter:title" content="Compressing PNG Output for R Packages with pngquant and ragg" />
    <meta name="twitter:description" content="Optimize PNG output sizes in R packages using pngquant and ragg, ensuring CRAN check compliance without compromising image quality.
" />
    <meta name="twitter:image" content="https://nanx.me/image/jametlene-reskp-hiu5XMrTvn0-unsplash.jpg" />
    <meta name="twitter:image:alt" content="Compressing PNG Output for R Packages with pngquant and ragg" />

    
    <meta property="og:linkedin:actor" content="nanxstats" />

    <link rel="canonical" href="https://nanx.me/blog/post/rpkgs-pngquant-ragg/">

    
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        serif: ['"Martina Plantijn"', 'Newsreader', 'Georgia', 'Cambria', '"Times New Roman"', 'Times', 'serif'],
                        sans: ['"Instrument Sans"', 'system-ui', '-apple-system', '"Segoe UI"', 'Roboto', '"Helvetica Neue"', 'Arial', 'sans-serif'],
                        mono: ['"Liga Noto Sans Mono"', 'ui-monospace', 'SFMono-Regular', '"SF Mono"', 'Menlo', 'Consolas', 'monospace'],
                    },
                    colors: {
                        paper: '#fdfdfd',
                        ink: '#1c1c1c',
                        accent: '#991b1b',  
                    },
                    typography: {
                        DEFAULT: {
                            css: {
                                maxWidth: 'none',
                                color: '#1c1c1c',
                                '--tw-prose-body': '#1c1c1c',
                                '--tw-prose-headings': '#1c1c1c',
                                '--tw-prose-links': '#991b1b',
                                '--tw-prose-bold': '#111827',
                                '--tw-prose-counters': '#71717a',
                                '--tw-prose-bullets': '#d4d4d8',
                                '--tw-prose-hr': '#e4e4e7',
                                '--tw-prose-quotes': '#1c1c1c',
                                '--tw-prose-quote-borders': '#d4d4d8',
                                '--tw-prose-captions': '#71717a',
                                '--tw-prose-code': '#1c1c1c',
                                '--tw-prose-pre-code': '#1c1c1c',
                                '--tw-prose-pre-bg': '#fdfdfd',
                                '--tw-prose-th-borders': '#d4d4d8',
                                '--tw-prose-td-borders': '#e4e4e7',
                                'pre': {
                                    color: '#1c1c1c',
                                    backgroundColor: '#fdfdfd !important',
                                    border: '1px solid #e4e4e7',
                                },
                                a: {
                                    color: '#991b1b',
                                    textDecoration: 'none',
                                    fontWeight: '400',
                                    borderBottom: '1px solid transparent',
                                    transition: 'border-color 0.2s ease, color 0.2s ease',
                                },
                                'a:hover': {
                                    color: '#991b1b !important',
                                    borderBottomColor: '#991b1b !important',
                                },
                                h1: { fontFamily: '"Instrument Sans", sans-serif', fontWeight: '500', letterSpacing: '-0.025em' },
                                h2: { fontFamily: '"Instrument Sans", sans-serif', fontWeight: '500', letterSpacing: '-0.025em', marginTop: '2em' },
                                h3: { fontFamily: '"Instrument Sans", sans-serif', fontWeight: '500' },
                                h4: { fontFamily: '"Instrument Sans", sans-serif', fontWeight: '500' },
                                blockquote: {
                                    fontStyle: 'italic',
                                    fontWeight: '400',
                                    borderLeftWidth: '2px',
                                },
                                'code::before': { content: 'none' },
                                'code::after': { content: 'none' },
                                ':not(pre) > code': {
                                    fontWeight: '400',
                                    color: '#1c1c1c !important',
                                    backgroundColor: '#f4f4f5 !important',
                                    padding: '0.2em 0.4em',
                                    borderRadius: '0.25rem',
                                    fontSize: '0.875em',
                                },
                            },
                        },
                    },
                },
            },
        }
    </script>

    <style type="text/tailwindcss">
        @layer utilities {
            .tufte-grid {
                display: grid;
                grid-template-columns: 1fr min(65ch, 100%) 1fr;
                column-gap: 2rem;
            }
            .tufte-grid > * {
                grid-column: 2;
            }
            .tufte-grid > .full-width {
                grid-column: 1 / -1;
            }
            .tufte-grid > .margin-note {
                grid-column: 3;
                font-family: "Instrument Sans", sans-serif;
                font-size: 0.875rem;
                line-height: 1.4;
                color: #52525b;  
                margin-top: 0.25rem;
            }
            @media (max-width: 1024px) {
                .tufte-grid {
                    grid-template-columns: 1rem 1fr 1rem;
                }
                .tufte-grid > .margin-note {
                    grid-column: 2;
                    margin-top: 0.5rem;
                    margin-bottom: 1rem;
                    padding-left: 1rem;
                    border-left: 2px solid #e4e4e7;
                }
            }
        }
    </style>

    <link rel="stylesheet" href="https://nanx.me/css/custom.css" />

    
    <link rel="stylesheet" href="https://nanx.me/css/textmate.css" />
    

    

    <link rel="shortcut icon"
        href="https://nanx.me/image/favicon.png">

    
</head>

<body class="bg-paper text-ink font-serif antialiased selection:bg-zinc-200">
    
<header class="py-8 lg:py-12 text-sm font-sans tracking-wide max-w-[67ch] mx-auto w-full px-4 sm:px-6">
    <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 sm:gap-0">
        <a href="https://nanx.me/" class="font-medium text-ink hover:text-accent transition-colors">
            Nan Xiao
        </a>
        <nav class="flex flex-wrap gap-4 sm:gap-6 text-zinc-600">
            
            
            <a class="text-ink font-medium"
                href="https://nanx.me/blog/">
                Blog
            </a>
            
            <a class="hover:text-accent transition-colors"
                href="https://nanx.me/software/">
                Software
            </a>
            
            <a class="hover:text-accent transition-colors"
                href="https://nanx.me/papers/">
                Papers
            </a>
            
            <a class="hover:text-accent transition-colors"
                href="https://nanx.me/talks/">
                Talks
            </a>
            
            <a class="hover:text-accent transition-colors"
                href="https://nanx.me/books/">
                Books
            </a>
            
            <a class="hover:text-accent transition-colors"
                href="https://nanx.me/about/">
                About
            </a>
            
        </nav>
    </div>
</header>

<main class="content my-10 lg:my-20 max-w-[65ch] mx-auto w-full px-4 sm:px-6">
    <article>
        <header class="mb-14">
            <h1 class="text-3xl lg:text-4xl font-sans tracking-tight text-ink font-medium mb-4">Compressing PNG Output for R Packages with pngquant and ragg</h1>

            <div class="text-zinc-500 font-sans text-sm tracking-wide">
                
                
                <span class="author" title="Nan Xiao">
                    Nan Xiao
                </span>
                
                

                <span class="date middot" title='Sun Apr 9 2023 00:30:00 UTC'>
                    April 9, 2023
                </span>

                <span class="reading-time middot">
                    3 min read
                </span>

                <div class="mt-8 flex flex-wrap gap-2">
                    
                    <a href="https://nanx.me/%20tags/r"
                        class="inline-flex items-center px-3 py-1 rounded-full bg-zinc-100 text-zinc-600 hover:bg-zinc-200 hover:text-ink transition-colors text-xs font-medium tracking-wide">
                        R
                    </a>
                    
                    <a href="https://nanx.me/%20tags/r-packages"
                        class="inline-flex items-center px-3 py-1 rounded-full bg-zinc-100 text-zinc-600 hover:bg-zinc-200 hover:text-ink transition-colors text-xs font-medium tracking-wide">
                        R packages
                    </a>
                    
                    <a href="https://nanx.me/%20tags/pngquant"
                        class="inline-flex items-center px-3 py-1 rounded-full bg-zinc-100 text-zinc-600 hover:bg-zinc-200 hover:text-ink transition-colors text-xs font-medium tracking-wide">
                        pngquant
                    </a>
                    
                    <a href="https://nanx.me/%20tags/ragg"
                        class="inline-flex items-center px-3 py-1 rounded-full bg-zinc-100 text-zinc-600 hover:bg-zinc-200 hover:text-ink transition-colors text-xs font-medium tracking-wide">
                        ragg
                    </a>
                    
                    <a href="https://nanx.me/%20tags/r-markdown"
                        class="inline-flex items-center px-3 py-1 rounded-full bg-zinc-100 text-zinc-600 hover:bg-zinc-200 hover:text-ink transition-colors text-xs font-medium tracking-wide">
                        R Markdown
                    </a>
                    
                    <a href="https://nanx.me/%20tags/image-compression"
                        class="inline-flex items-center px-3 py-1 rounded-full bg-zinc-100 text-zinc-600 hover:bg-zinc-200 hover:text-ink transition-colors text-xs font-medium tracking-wide">
                        image compression
                    </a>
                    
                    <a href="https://nanx.me/%20tags/png-optimization"
                        class="inline-flex items-center px-3 py-1 rounded-full bg-zinc-100 text-zinc-600 hover:bg-zinc-200 hover:text-ink transition-colors text-xs font-medium tracking-wide">
                        PNG optimization
                    </a>
                    
                    
                    
                </div>
            </div>

        </header>

        <div class="prose prose-zinc max-w-none">
            
    


<div class="float">
<img src="https://nanx.me/image/jametlene-reskp-hiu5XMrTvn0-unsplash.jpg" alt="Cassette collection. Photo by Jametlene Reskp." />
<div class="figcaption">Cassette collection. Photo by <a href="https://unsplash.com/photos/hiu5XMrTvn0">Jametlene Reskp</a>.</div>
</div>
<div id="introduction" class="section level2">
<h2>Introduction</h2>
<p>Dealing with large-scale image outputs in R packages can be challenging,
especially when it comes to passing CRAN checks. In this post,
I will share my experience in using pngquant and ragg to compress the PNG output
size for readme and vignettes. This allows R packages with many figures in
their documentation to pass the CRAN checks without compromising image quality.</p>
</div>
<div id="problem-description" class="section level2">
<h2>Problem description</h2>
<p>I encountered a problem with my package, <a href="https://nanx.me/ggsci/">ggsci</a>,
which outputs approximately 30 example figures from both vignettes and
<code>README.Rmd</code>. This exceeds the directory and total file size limits that
<code>R CMD check</code> allows. For example, without any optimization, running
<code>R CMD check</code> on ggsci will issue a check note like this:</p>
<pre class="text"><code>installed size is  5.1Mb
sub-directories of 1Mb or more:
  doc    2.7Mb
  help   2.3Mb</code></pre>
<p>The <code>doc/</code> directory contains the HTML vignette with base64 encoded PNG images,
while the <code>help/</code> directory includes PNG outputs from <code>README.Rmd</code> in
<code>man/figures/</code>. To avoid this check note, my goal is to compress
the output images as much as possible without sacrificing observable
image quality.</p>
</div>
<div id="initial-solution-svg" class="section level2">
<h2>Initial solution: SVG</h2>
<p>I first attempted using SVG output. For my figures,
<a href="https://svglite.r-lib.org/">svglite</a> provided the smallest
file size (100 Kb vs. 300 Kb) compared to
<a href="https://rdrr.io/r/grDevices/cairo.html"><code>grDevices::svg()</code></a> and
<a href="https://cran.r-project.org/package=gridSVG">gridSVG</a>.
This is likely because svglite does not encode text as polygons.
However, 100 Kb per image was still too large. As my examples included
scatterplots with many data points, further reducing the vector-based SVG file
size would require significantly reducing the number of data points in the examples.
Consequently, I did not take this approach.</p>
</div>
<div id="final-solution-optimize-png-output-with-pngquant-ragg" class="section level2">
<h2>Final solution: optimize PNG output with pngquant + ragg</h2>
<p>Eventually, I came back to optimizing PNG outputs. I discovered that
the <code>ragg_png()</code> device in the <a href="https://ragg.r-lib.org/">ragg</a> package
produced the smallest PNG outputs, approximately 120 Kb per image.
By using <a href="https://pngquant.org/">pngquant</a> for lossy compression,
I was able to reduce the size further to around 30 Kb per image.
My knitr chunk options are
(please note that these might require tuning for your use case):</p>
<pre class="r"><code>knitr::knit_hooks$set(pngquant = knitr::hook_pngquant)

knitr::opts_chunk$set(
  dev = &quot;ragg_png&quot;,
  dpi = 72,
  fig.retina = 2,
  fig.width = 10.6667,
  fig.height = 3.3334,
  fig.align = &quot;center&quot;,
  out.width = &quot;100%&quot;,
  pngquant = &quot;--speed=1 --quality=50&quot;
)</code></pre>
<p>Some technical explanations on why this works:</p>
<ol style="list-style-type: decimal">
<li>Since CRAN does not re-do <code>R CMD build</code> nor re-render vignettes and will
reuse the built vignettes in the uploaded tarball, it’s only necessary
to have pngquant installed in the maintainer’s build environment running
<code>R CMD build</code>. This ensures that the submitted tarball contains minimized images.</li>
<li>Even with the pngquant hook set up, knitr can still render the R Markdown
vignettes normally in environments without pngquant installed, so there
will be no issues on CRAN build machines when they run <code>R CMD check</code>
on the tarball uploaded by the package maintainer.</li>
<li>The r-lib/actions GitHub Actions workflows do not have pngquant installed.
In these workflows, <code>R CMD build</code> is ran first to build a tarball and
<code>R CMD check</code> is used to check it. In this case, there will be a check
note about the file and directory sizes. This is ok though because
having check notes is still considered as passing for these workflows
by default. You can change this default behavior by adjusting the <code>error-on</code>
<a href="https://github.com/r-lib/actions/tree/v2-branch/check-r-package">option</a>
to make it more or less strict.</li>
<li>The output images of <code>README.Rmd</code> will not be regenerated on any machines
besides the maintainer’s build environment. Regeneration only happens when
the file is rendered manually. So they will just work ok.</li>
</ol>
<p>That’s it. I hope these tips are useful for reducing your R package size
without having to remove valuable figures from the documentation.</p>
</div>



        </div>

        
        <nav class="pagination-nav mt-10 mb-3" aria-label="Blog post navigation">
            <div class="navigation-btns">
                
                <a href="https://nanx.me/blog/post/mlmodern/" class="btn-nav btn-prev w-full">
                    <div class="btn-content">
                        <div class="pagination-nav-sublabel">Previous</div>
                        <div class="pagination-nav-label">&laquo; Bolden Your Typography in R Markdown and Quarto with MLModern</div>
                    </div>
                </a>
                

                
                <a href="https://nanx.me/blog/post/open-source-typography/" class="btn-nav btn-next w-full">
                    <div class="btn-content">
                        <div class="pagination-nav-sublabel">Next</div>
                        <div class="pagination-nav-label">Find Your Perfect Open Source Font: Introducing the Interactive Typeface Lookbook &raquo;</div>
                    </div>
                </a>
                
            </div>
        </nav>
        

    </article>
</main>

<section id="comments">
    <div class="py-3 content">
        <div class="mx-auto max-w-[65ch] w-full px-4 sm:px-6">
            <div class="comments">
                <script src="https://utteranc.es/client.js" repo="nanxstats/blog-comments" issue-term="pathname"
                    label="comment" theme="github-light" crossorigin="anonymous" async>
                    </script>
            </div>
        </div>
    </div>
</section>
<footer class="mt-20 mb-10 text-center font-sans text-sm text-zinc-500 tracking-wide">
    <div class="tufte-grid">
        <div class="flex flex-col items-center gap-4">
            <div class="flex flex-wrap items-center justify-center gap-x-4 gap-y-2">
                
                
                <a href="https://github.com/nanxstats" target="_blank" rel="noopener"
                    class="hover:text-accent transition-colors">GitHub</a>
                
                
                
                
                <a href="https://www.linkedin.com/in/nanxstats" target="_blank" rel="noopener"
                    class="hover:text-accent transition-colors">LinkedIn</a>
                
                
                <a href="https://bsky.app/profile/nanxstats.bsky.social" target="_blank" rel="noopener"
                    class="hover:text-accent transition-colors">Bluesky</a>
                
                
                <a href="https://twitter.com/nanxstats" target="_blank" rel="noopener"
                    class="hover:text-accent transition-colors">Twitter</a>
                
                
                
                <a href="https://nanx.me/colophon/" class="hover:text-accent transition-colors">Colophon</a>
                
                
            </div>

            
            <div class="mt-2">
                © 2026 Nan Xiao. All rights reserved.
            </div>
            
        </div>
    </div>
</footer>


    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/highlight.min.js"
        integrity="sha512-EBLzUL8XLl+va/zAsmXwS7Z2B1F9HUHkZwyS/VKwh3S7T/U0nF4BaU29EP/ZSf6zgiIxYAnKLu6bJ8dqpmX5uw=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/languages/r.min.js" defer></script>
    
    <script>
        window.addEventListener('load', function () {
            hljs.highlightAll();
        }, true);
    </script>
    

    

    
    
    
<script src="https://nanx.me/js/math-code.js"></script>
<script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js?config=TeX-MML-AM_CHTML"></script>


    
</body>

</html>